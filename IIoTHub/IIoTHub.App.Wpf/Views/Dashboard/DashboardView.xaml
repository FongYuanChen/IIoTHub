<UserControl x:Class="IIoTHub.App.Wpf.Views.Dashboard.DashboardView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:viewModels="clr-namespace:IIoTHub.App.Wpf.ViewModels.Dashboard"
             xmlns:views="clr-namespace:IIoTHub.App.Wpf.Views.Dashboard"
             xmlns:multiValueConverters="clr-namespace:IIoTHub.App.Wpf.ViewModels.MultiValueConverter"
             xmlns:valueConverters="clr-namespace:IIoTHub.App.Wpf.ViewModels.ValueConverter"
             mc:Ignorable="d">

    <UserControl.Resources>
        <valueConverters:CollapsePanelIconConverter x:Key="CollapsePanelIconConverter" ExpandedIcon="⮞" CollapsedIcon="⮜"/>
        <valueConverters:CollapsePanelLeftWidthConverter x:Key="CollapsePanelLeftWidthConverter" Expanded="300" Collapsed="*"/>
        <valueConverters:CollapsePanelRightWidthConverter x:Key="CollapsePanelRightWidthConverter" Expanded="*" Collapsed="0"/>
        <valueConverters:DeviceStatusToBrushConverter x:Key="DeviceStatusToBrushConverter" />
    </UserControl.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 上方狀態總覽 -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10" HorizontalAlignment="Center">

            <!-- 稼動率 -->
            <Border Background="#2196F3" CornerRadius="6" Padding="15" Width="160" Height="90" Margin="10">
                <StackPanel>
                    <TextBlock Text="稼動率" Foreground="White" FontSize="16" FontWeight="Bold"/>
                    <TextBlock Text="{Binding AverageUtilization, StringFormat={}{0:P0}}" Foreground="White" FontSize="32" FontWeight="Bold"/>
                </StackPanel>
            </Border>

            <!-- 運轉 -->
            <Border Background="{StaticResource DeviceStatusRunningBrush}" CornerRadius="6" Padding="15" Width="160" Margin="10">
                <StackPanel>
                    <TextBlock Text="運轉" Foreground="White" FontSize="16" FontWeight="Bold"/>
                    <TextBlock Foreground="White" FontWeight="Bold">
                        <Run Text="{Binding RunDeviceCount, Mode=OneWay}" FontSize="32"/>
                        <Run Text=" / " FontSize="16"/>
                        <Run Text="{Binding DeviceCount, Mode=OneWay}" FontSize="16"/>
                        <Run Text="台" FontSize="16"/>
                    </TextBlock>
                </StackPanel>
            </Border>

            <!-- 待機 -->
            <Border Background="{StaticResource DeviceStatusStandbyBrush}" CornerRadius="6" Padding="15" Width="160" Margin="10">
                <StackPanel>
                    <TextBlock Text="待機" Foreground="White" FontSize="16" FontWeight="Bold"/>
                    <TextBlock Foreground="White" FontWeight="Bold">
                        <Run Text="{Binding StandbyDeviceCount, Mode=OneWay}" FontSize="32"/>
                        <Run Text=" / " FontSize="16"/>
                        <Run Text="{Binding DeviceCount, Mode=OneWay}" FontSize="16"/>
                        <Run Text="台" FontSize="16"/>
                    </TextBlock>
                </StackPanel>
            </Border>

            <!-- 報警 -->
            <Border Background="{StaticResource DeviceStatusAlarmBrush}" CornerRadius="6" Padding="15" Width="160" Margin="10">
                <StackPanel>
                    <TextBlock Text="警報" Foreground="White" FontSize="16" FontWeight="Bold"/>
                    <TextBlock Foreground="White" FontWeight="Bold">
                        <Run Text="{Binding AlarmDeviceCount, Mode=OneWay}" FontSize="32"/>
                        <Run Text=" / " FontSize="16"/>
                        <Run Text="{Binding DeviceCount, Mode=OneWay}" FontSize="16"/>
                        <Run Text="台" FontSize="16"/>
                    </TextBlock>
                </StackPanel>
            </Border>

            <!-- 離線 -->
            <Border Background="{StaticResource DeviceStatusOfflineBrush}" CornerRadius="6" Padding="15" Width="160" Margin="10">
                <StackPanel>
                    <TextBlock Text="離線" Foreground="White" FontSize="16" FontWeight="Bold"/>
                    <TextBlock Foreground="White" FontWeight="Bold">
                        <Run Text="{Binding OfflineDeviceCount, Mode=OneWay}" FontSize="32"/>
                        <Run Text=" / " FontSize="16"/>
                        <Run Text="{Binding DeviceCount, Mode=OneWay}" FontSize="16"/>
                        <Run Text="台" FontSize="16"/>
                    </TextBlock>
                </StackPanel>
            </Border>

        </StackPanel>

        <!-- 下方設備小卡清單 -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <!-- 設備小卡清單顯示區 -->
                <ColumnDefinition Width="{Binding IsDeviceDetailPaneExpanded, Converter={StaticResource CollapsePanelLeftWidthConverter}}" />
                <!-- 收合展開按鈕 -->
                <ColumnDefinition Width="32" />
                <!-- 設備詳細內容顯示區 -->
                <ColumnDefinition Width="{Binding IsDeviceDetailPaneExpanded, Converter={StaticResource CollapsePanelRightWidthConverter}}" />
            </Grid.ColumnDefinitions>

            <!-- 設備小卡清單顯示區 -->
            <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto">
                <ItemsControl ItemsSource="{Binding DevicesWithAddButton}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal" HorizontalAlignment="Center"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                    <ItemsControl.Resources>
                        <multiValueConverters:UtilizationToCircleDashConverter x:Key="UtilizationToCircleDashConverter"/>

                        <!-- 小卡模板 -->
                        <DataTemplate DataType="{x:Type viewModels:DeviceViewModelBase}">
                            <Border Margin="10" Padding="0" Width="224" Height="300" Style="{DynamicResource DropShadowHoverCardStyle}">
                                <Grid>

                                    <!-- 狀態色條 -->
                                    <Border Height="12" VerticalAlignment="Top" CornerRadius="12,12,0,0" Background="{Binding Status, Converter={StaticResource DeviceStatusToBrushConverter}}" />

                                    <StackPanel Margin="12,24,12,12">

                                        <!-- 監控開關 -->
                                        <Grid Margin="0,0,0,4">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <ToggleButton Grid.Column="1" Width="32" Height="16" ToolTip="監控開關" IsChecked="{Binding IsMonitoring, Mode=TwoWay}" Command="{Binding MonitorCommand}" Cursor="Hand">
                                                <ToggleButton.Template>
                                                    <ControlTemplate TargetType="ToggleButton">
                                                        <Grid>
                                                            <Border x:Name="Bg" CornerRadius="8" Background="#CCC"/>
                                                            <Ellipse x:Name="Dot" Width="12" Height="12" Fill="White" HorizontalAlignment="Left" Margin="2"/>
                                                        </Grid>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsChecked" Value="True">
                                                                <Setter TargetName="Bg" Property="Background" Value="#4CAF50"/>
                                                                <Setter TargetName="Dot" Property="HorizontalAlignment" Value="Right"/>
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </ToggleButton.Template>
                                            </ToggleButton>
                                        </Grid>

                                        <!-- 稼動率圓形進度條 -->
                                        <Grid Width="200" Height="200" Margin="0,0,0,12">
                                            <Ellipse Stroke="#eee" StrokeThickness="8" Width="200" Height="200"/>
                                            <Ellipse Stroke="#2196F3" StrokeThickness="8" Width="200" Height="200" StrokeDashCap="Round" RenderTransformOrigin="0.5,0.5">
                                                <Ellipse.StrokeDashArray>
                                                    <MultiBinding Converter="{StaticResource UtilizationToCircleDashConverter}">
                                                        <Binding Path="Utilization"/>
                                                        <Binding RelativeSource="{RelativeSource Self}" Path="Width"/>
                                                        <Binding RelativeSource="{RelativeSource Self}" Path="StrokeThickness"/>
                                                    </MultiBinding>
                                                </Ellipse.StrokeDashArray>
                                                <Ellipse.RenderTransform>
                                                    <RotateTransform Angle="-90"/>
                                                </Ellipse.RenderTransform>
                                            </Ellipse>

                                            <!-- 內文: 設備名稱, 圖示, 稼動率百分比 -->
                                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                <TextBlock Text="{Binding Name}" FontSize="18" FontWeight="SemiBold" Foreground="#333" TextTrimming="CharacterEllipsis" HorizontalAlignment="Center"/>
                                                <Image Source="{Binding ImageSource}" Width="100" Height="100" Stretch="Uniform" HorizontalAlignment="Center" Margin="0,8,0,8"/>
                                                <TextBlock Text="{Binding Utilization, StringFormat={}{0:P0}}" FontWeight="Bold" FontSize="16" HorizontalAlignment="Center"/>
                                            </StackPanel>
                                        </Grid>

                                        <!-- 按鈕列 -->
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                            <Button Width="32" Height="32" Background="Transparent" BorderThickness="0" Cursor="Hand" Margin="0,0,8,0" Command="{Binding ViewCommand}" ToolTip="詳細資訊">
                                                <TextBlock FontFamily="Segoe MDL2 Assets" Foreground="DodgerBlue" Text="&#xE946;" FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Button>
                                            <Button Width="32" Height="32" Background="Transparent" BorderThickness="0" Cursor="Hand" Margin="0,0,8,0" Command="{Binding EditCommand}" ToolTip="編輯">
                                                <TextBlock FontFamily="Segoe MDL2 Assets" Foreground="Orange" Text="&#xE70F;" FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Button>
                                            <Button Width="32" Height="32" Background="Transparent" BorderThickness="0" Cursor="Hand" Margin="0,0,8,0" Command="{Binding CopyCommand}" ToolTip="複製">
                                                <TextBlock FontFamily="Segoe MDL2 Assets" Foreground="Green" Text="&#xE8C8;" FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Button>
                                            <Button Width="32" Height="32" Background="Transparent" BorderThickness="0" Cursor="Hand" Command="{Binding DeleteCommand}" ToolTip="刪除">
                                                <TextBlock FontFamily="Segoe MDL2 Assets" Foreground="Red" Text="&#xE74D;" FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Button>
                                        </StackPanel>

                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>

                        <!-- 新增設備小卡模板 -->
                        <DataTemplate DataType="{x:Type viewModels:DevicePlaceholderViewModel}">
                            <Border Margin="10" Width="224" Height="300" Cursor="Hand" Style="{DynamicResource DropShadowHoverCardStyle}">
                                <Border.InputBindings>
                                    <MouseBinding MouseAction="LeftClick" Command="{Binding AddCommand}" />
                                </Border.InputBindings>

                                <Grid>
                                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                        <TextBlock Text="+" FontSize="36" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        <TextBlock Text="添加設備" FontSize="18" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>

                    </ItemsControl.Resources>
                </ItemsControl>
            </ScrollViewer>

            <!-- 收合展開按鈕 -->
            <Button Grid.Column="1"
                Content="{Binding IsDeviceDetailPaneExpanded, Converter={StaticResource CollapsePanelIconConverter}}"
                Command="{Binding ToggleDeviceDetailPaneCommand}"
                Style="{StaticResource ModernButtonStyle}"
                Width="30"
                Height ="30"/>

            <!-- 設備詳細內容顯示區 -->
            <ContentControl Grid.Column="2" Content="{Binding SelectedDeviceViewModel}">
                <ContentControl.Resources>
                    <DataTemplate DataType="{x:Type viewModels:DeviceMachineViewModel}">
                        <views:DeviceMachineView/>
                    </DataTemplate>
                    <DataTemplate DataType="{x:Type viewModels:DeviceMagazineViewModel}">
                        <views:DeviceMagazineView/>
                    </DataTemplate>
                    <DataTemplate DataType="{x:Type viewModels:DeviceRobotViewModel}">
                        <views:DeviceRobotView/>
                    </DataTemplate>
                </ContentControl.Resources>
            </ContentControl>

        </Grid>

    </Grid>
</UserControl>